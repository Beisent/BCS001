# 光栅化三角形

由于三角形是最简单的欧几里得空间中的二维的多边形，他是构成更复杂图形的基本单元，所以三角形在计算机图形学中是一种非常重要的拓扑结构。

所以光栅化一个三角形面是非常重要的。三角形边框使用上一节的画线算法可以解决。

我们需要一个算法解决如下问题：

对于给定三个顶点$\mathbf{A},\mathbf{B},\mathbf{C}$，以及任意一个顶点$\mathbf{P}$

判断其是否在三角形内，如果在三角形内则设置该点颜色，否则不设置。

我们可以利用向量叉乘的性质，假设我们当前选择了点$\mathbf{P}$，

三角形有三条边，对应三个向量

- $\mathbf{AB = B-A}$
- $\mathbf{BC = C-B}$
- $\mathbf{CA = A-C}$

对于每条边，我们可以计算**点 P 与该边的向量叉乘**：

- $\mathbf{AB\times AP = (B-A)\times(P-A)}$
- $\mathbf{BC\times BP = (C-B)\times(P-B)}$
- $\mathbf{CA\times CP = (A-C)\times(P-C)}$

- 如果叉乘的符号相同（全为正或全为负），说明点 P 在三角形内部
- 如果有一个叉乘符号不同，说明点在三角形外部

> 这是因为叉乘的符号表示了向量的方向右手法则

我们应该怎么选择点 $\mathbf{P}$ 呢？我们可以通过遍历整个画面进行，但是计算叉乘的效率太慢了，我们需要一种简单的快速过滤算法。我们可以通过AABB包围盒来过滤，AABB是一种Bounding Box，是一个包围着几何体的边都与x，y轴平行的矩形。我们可以先计算出三角形的AABB然后通过判断点是否在AABB中进行快速过滤，我们通常这样定义AABB。

**AABB**

- **Vec2 min = {minx(A,B,C),miny(A,B,C)}**
- **Vec2 max ={maxx(A,B,C),maxy(A,B,C)}**

这时我们的三角形光栅化算法可以这么写

```c++
struct AABB
{
    lcg::Vec2 min;
    lcg::Vec2 max;
};

AABB computeAABB(const lcg::Vec2 &A, const lcg::Vec2 &B, const lcg::Vec2 &C)
{
    AABB box;
    box.min.x = std::min({A.x, B.x, C.x});
    box.min.y = std::min({A.y, B.y, C.y});
    box.max.x = std::max({A.x, B.x, C.x});
    box.max.y = std::max({A.y, B.y, C.y});
    return box;
}
void draw_triangle(lcg::PPM &ppm, lcg::Vec2 A, lcg::Vec2 B, lcg::Vec2 C)
{
    AABB box = computeAABB(A, B, C);

    lcg::Vec2 AB = B - A;
    lcg::Vec2 BC = C - B;
    lcg::Vec2 CA = A - C;

    for (int y = (int)box.min.y; y <= (int)box.max.y; ++y)
    {
        for (int x = (int)box.min.x; x <= (int)box.max.x; ++x)
        {
            lcg::Vec2 P((float)x + 0.5f, (float)y + 0.5f);

            lcg::Vec2 AP = P - A;
            lcg::Vec2 BP = P - B;
            lcg::Vec2 CP = P - C;

            float cross1 = AB.cross(AP);
            float cross2 = BC.cross(BP);
            float cross3 = CA.cross(CP);

            if ((cross1 >= 0 && cross2 >= 0 && cross3 >= 0) ||
                (cross1 <= 0 && cross2 <= 0 && cross3 <= 0))
            {
                ppm.setPixel(x, y, 255, 255, 255);
            }
        }
    }
}
```

